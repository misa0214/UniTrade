<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSwap - Campus Marketplace</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        /* Custom Navbar */
        .navbar-custom {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
        }

        .logo-placeholder {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-link {
            color: var(--text-primary) !important;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover {
            color: var(--accent-color) !important;
            transform: translateY(-2px);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            transition: all 0.3s ease;
        }

        .nav-link:hover::after {
            width: 80%;
            left: 10%;
        }

        /* Hero Section */
        .hero-section {
            padding: 100px 0 50px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Search Bar */
        .search-container {
            margin: 3rem 0;
            position: relative;
        }

        .search-bar {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 1rem 3rem 1rem 1.5rem;
            font-size: 1.1rem;
            color: var(--text-primary);
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .search-bar::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        /* Category Cards */
        .category-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }

        .category-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
        }

        .category-icon {
            font-size: 3rem;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .category-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Item Cards */
        .item-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .item-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            padding: 1.5rem;
        }

        .item-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .item-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .item-condition {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-color);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .seller-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Custom Buttons */
        .btn-gradient {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .btn-outline-gradient {
            background: transparent;
            border: 2px solid var(--accent-color);
            border-radius: 50px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: var(--accent-color);
            transition: all 0.3s ease;
        }

        .btn-outline-gradient:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        /* Footer */
        .footer {
            background: var(--dark-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem 0 2rem;
            margin-top: 5rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border-radius: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-section {
                padding: 80px 0 30px;
            }
            
            .search-bar {
                padding: 0.8rem 2.5rem 0.8rem 1rem;
                font-size: 1rem;
            }
            
            .category-card {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
        }
    
        /* --- Chat modal styles --- */
        .chat-window{background:var(--dark-surface);border:1px solid var(--card-border, rgba(255,255,255,.08));border-radius:16px;overflow:hidden;}
        .chat-header{background:linear-gradient(180deg, #2a2f4a, #1b2138);padding:.75rem 1rem;color:#e5e7eb;border-bottom:1px solid rgba(255,255,255,.08)}
        .chat-title{font-weight:800;font-size:1.25rem}
        .chat-sub{font-size:.8rem;opacity:.8}
        .chat-body{height:320px;overflow:auto;background:rgba(255,255,255,.02);padding:12px}
        .bubble{max-width:75%;padding:.5rem .75rem;border-radius:14px;margin:.25rem 0;position:relative;line-height:1.35}
        .me{background:#6366f1; color:#fff; margin-left:auto;}
        .them{background:#374151; color:#e5e7eb; margin-right:auto;}
        .time{font-size:.7rem;opacity:.7;margin-top:2px}
        .chat-input{display:flex;gap:.5rem;padding:.75rem;background:rgba(255,255,255,.03);border-top:1px solid rgba(255,255,255,.08)}
        .chat-input input{flex:1;border-radius:24px;border:1px solid rgba(255,255,255,.15);padding:.6rem .9rem;background:#0b1220;color:#e5e7eb}
        .chat-send{border-radius:24px}
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#home">
                <div class="logo-placeholder">US</div>
                UniSwap
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#browse" onclick="showBrowse()">Browse</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#collection-desk" onclick="showCollectionDesk()">Collection Desk</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-gradient btn-sm" onclick="showPostAd()">
                            <i class="bi bi-plus-circle me-1"></i>Post Ad
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="hero-title">UniSwap Campus Marketplace</h1>
                    <p class="hero-subtitle">Buy, sell, and trade with fellow students. Safe, local, and convenient.</p>
                    
                    <div class="search-container">
                        <div class="position-relative">
                            <input type="text" class="search-bar" placeholder="Search for textbooks, electronics, furniture..." id="searchInput">
                            <button class="search-btn" onclick="performSearch()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-3 justify-content-center">
                        <button class="btn btn-gradient" onclick="showBrowse()">
                            <i class="bi bi-grid me-2"></i>Browse Items
                        </button>
                        <button class="btn btn-outline-gradient" onclick="showPostAd()">
                            <i class="bi bi-plus-circle me-2"></i>Post an Ad
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section id="categories" class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="h1 mb-3">Popular Categories</h2>
                <p class="text-secondary">Find exactly what you're looking for</p>
            </div>
            
            <div class="row g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="category-card" onclick="filterByCategory('textbooks')">
                        <div class="category-icon">
                            <i class="bi bi-book"></i>
                        </div>
                        <h4 class="category-title">Textbooks</h4>
                        <p class="text-secondary">Academic books and study materials</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="category-card" onclick="filterByCategory('electronics')">
                        <div class="category-icon">
                            <i class="bi bi-laptop"></i>
                        </div>
                        <h4 class="category-title">Electronics</h4>
                        <p class="text-secondary">Laptops, phones, and gadgets</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="category-card" onclick="filterByCategory('furniture')">
                        <div class="category-icon">
                            <i class="bi bi-house"></i>
                        </div>
                        <h4 class="category-title">Furniture</h4>
                        <p class="text-secondary">Dorm and apartment essentials</p>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="category-card" onclick="filterByCategory('fashion')">
                        <div class="category-icon">
                            <i class="bi bi-bag"></i>
                        </div>
                        <h4 class="category-title">Fashion</h4>
                        <p class="text-secondary">Clothing and accessories</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Items Section -->
    <section id="items-section" class="py-5">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="h1 mb-2">Latest Items</h2>
                    <p class="text-secondary">Fresh listings from your campus community</p>
                </div>
            </div>
            
            <div class="row g-4" id="itemsGrid">
                <!-- Items will be dynamically loaded here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="logo-placeholder me-3">US</div>
                        <h5>UniSwap</h5>
                    </div>
                    <p class="text-secondary">Connecting students through safe and convenient local trading.</p>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="mb-3">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" onclick="showBrowse()" class="text-secondary">Browse Items</a></li>
                        <li><a href="#" onclick="showPostAd()" class="text-secondary">Post Ad</a></li>
                        <li><a href="#" onclick="showCollectionDesk()" class="text-secondary">Collection Desk</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="mb-3">Safety</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-secondary">Meet in Public</a></li>
                        <li><a href="#" class="text-secondary">Check Items First</a></li>
                        <li><a href="#" class="text-secondary">Trust Your Instincts</a></li>
                    </ul>
                </div>
            </div>
            
            <hr class="border-secondary">
            <div class="text-center">
                <p class="text-secondary mb-0">&copy; 2025 UniSwap. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">
        <i class="bi bi-arrow-up"></i>
    </button>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let items = [];
        
        let uploadedImages = [];
let messages = {};
        let currentChatUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeBackToTop();
            updateItemsDisplay();
            showToast('Welcome to UniSwap Campus Marketplace!', 'success');
            
            // Add sample items after 5 seconds if none posted
            setTimeout(() => {
                if (items.length === 0) {
                    addSampleItems();
                }
            }, 5000);
        });

        // Add sample items
        function addSampleItems() {
            showToast('Adding sample items to get you started!', 'info');
            
            items = [
                {
                    id: 1,
                    title: "Calculus Textbook - Stewart 8th Edition",
                    price: "RM 85",
                    category: "textbooks",
                    condition: "Good",
                    description: "Used for one semester. Minimal highlighting, no missing pages. Great for MATH 1410 students. Includes solution manual.",
                    seller: "Sarah M.",
                    contactMethod: "Email",
                    location: "Campus Library",
                    images: uploadedImages,
                    createdAt: new Date().toLocaleDateString()
                },
                {
                    id: 2,
                    title: "MacBook Air M1 2020",
                    price: "RM 650",
                    category: "electronics",
                    condition: "Excellent",
                    description: "Barely used, still under warranty. Comes with original charger and box. Perfect for programming and design work. 8GB RAM, 256GB SSD.",
                    seller: "Mike R.",
                    contactMethod: "Phone",
                    location: "Student Center",
                    images: [],
                    createdAt: new Date().toLocaleDateString()
                },
                {
                    id: 3,
                    title: "Study Desk with Drawers",
                    price: "RM 120",
                    category: "furniture",
                    condition: "Good",
                    description: "Wooden study desk with 3 drawers. Perfect for dorm room or small apartment. Minor scratches but very sturdy.",
                    seller: "Emma L.",
                    contactMethod: "Campus Chat",
                    location: "Collection Desk",
                    images: [],
                    createdAt: new Date().toLocaleDateString()
                },
                {
                    id: 4,
                    title: "Winter Jacket - Uniqlo Size M",
                    price: "RM 45",
                    category: "fashion",
                    condition: "Like New",
                    description: "Bought last winter, worn only a few times. Very warm and comfortable. Perfect for Malaysian air conditioning!",
                    seller: "David W.",
                    contactMethod: "Email",
                    location: "Campus Library",
                    images: [],
                    createdAt: new Date().toLocaleDateString()
                }
            ];
            
            updateItemsDisplay();
        }

        // Update items display
        function updateItemsDisplay() {
            const grid = document.getElementById('itemsGrid');
            
            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-box-seam"></i>
                            <h4>No items yet</h4>
                            <p>Be the first to post an item for sale!</p>
                            <button class="btn btn-gradient mt-3" onclick="showPostAd()">
                                <i class="bi bi-plus-circle me-2"></i>Post First Ad
                            </button>
                        </div>
                    </div>
                `;
            } else {
                grid.innerHTML = items.map(item => `
                    <div class="col-lg-4 col-md-6">
                        <div class="item-card" onclick="showItemDetails(${item.id})">
                            <div class="item-image">
                                ${item.images && item.images.length > 0 ? 
                                    `<img src="${item.images[0].data}" alt="${item.title}">` :
                                    `<i class="bi bi-${getIconByCategory(item.category)}"></i>`
                                }
                            </div>
                            <div class="item-info">
                                <div class="item-price">${item.price}</div>
                                <div class="item-title">${item.title}</div>
                                <div class="mt-2">
                                    <span class="item-condition">${item.condition}</span>
                                    <span class="seller-badge">${item.seller}</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-secondary">
                                        <i class="bi bi-geo-alt me-1"></i>${item.location || 'Campus'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Get icon by category
        function getIconByCategory(category) {
            const icons = {
                'textbooks': 'book',
                'electronics': 'laptop',
                'furniture': 'house',
                'fashion': 'bag',
                'sports': 'bicycle'
            };
            return icons[category] || 'box';
        }

        // Show post ad modal
        function showPostAd() {
            Swal.fire({
                title: 'Post New Ad',
                html: `
                    <form id="postAdForm" class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Item Title</label>
                            <input type="text" class="form-control" id="itemTitle" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Price ($)</label>
                                <input type="number" class="form-control" id="itemPrice" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="itemCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="textbooks">Textbooks</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="fashion">Fashion</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Condition</label>
                            <select class="form-select" id="itemCondition" required>
                                <option value="">Select Condition</option>
                                <option value="Like New">Like New</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Your Name</label>
                            <input type="text" class="form-control" id="sellerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Method</label>
                            <select class="form-select" id="contactMethod" required>
                                <option value="">Select Method</option>
                                <option value="Email">Email</option>
                                <option value="Phone">Phone</option>
                                <option value="Campus Chat">Campus Chat</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Meetup Location</label>
                            <select class="form-select" id="meetupLocation">
                                <option value="Campus Library">Campus Library</option>
                                <option value="Student Center">Student Center</option>
                                <option value="Collection Desk">Collection Desk</option>
                            </select>
                        </div>
                    
                        <div class="mb-3">
                            <label class="form-label">Photos (up to 5)</label>
                            <input type="file" class="form-control" id="itemImages" accept="image/*" multiple>
                            <div id="imagePreview" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-gradient">Post Ad</button>
                        </div>
</form>
                `,
                width: '600px',
                background: 'var(--dark-surface)',
                color: 'var(--text-primary)',
                showConfirmButton: false,
                showCancelButton: true,
                confirmButtonText: 'Post Ad',
                cancelButtonText: 'Cancel',
                showCloseButton: true,
                didOpen: () => {
                    // hook submit
                    document.getElementById('postAdForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        submitPostAd();
                    });
                    // image preview
                    uploadedImages = [];
                    const fileInput = document.getElementById('itemImages');
                    const preview = document.getElementById('imagePreview');
                    if (fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const files = Array.from(e.target.files).slice(0,5);
                            uploadedImages = [];
                            if (preview) preview.innerHTML='';
                            files.forEach(file => {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const dataUrl = reader.result;
                                    uploadedImages.push({name:file.name, data:dataUrl, size:file.size, type:file.type});
                                    if (preview) {
                                        const img = document.createElement('img');
                                        img.src = dataUrl;
                                        img.style.width = '64px';
                                        img.style.height = '64px';
                                        img.style.objectFit = 'cover';
                                        img.className = 'rounded';
                                        preview.appendChild(img);
                                    }
                                };
                                reader.readAsDataURL(file);
                            });
                        });
                    }
                }
            });
        }

        // Submit post ad
        function submitPostAd() {
            const newItem = {
                id: Date.now(),
                title: document.getElementById('itemTitle').value,
                price: 'RM ' + document.getElementById('itemPrice').value,
                category: document.getElementById('itemCategory').value,
                condition: document.getElementById('itemCondition').value,
                description: document.getElementById('itemDescription').value,
                seller: document.getElementById('sellerName').value,
                contactMethod: document.getElementById('contactMethod').value,
                location: document.getElementById('meetupLocation').value,
                images: [],
                createdAt: new Date().toLocaleDateString()
            };
            
            items.unshift(newItem);
            updateItemsDisplay();
            Swal.close();
            showToast('Item posted successfully!', 'success');
        }

        // Show browse modal
        function showBrowse(list = null) {
            const data = list || items;
            const itemsHtml = data.length > 0 ? data.map(item => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card bg-dark border-secondary h-100" style="cursor: pointer;" onclick="showItemDetails(${item.id})">
                        <div class="card-body">
                            <h6 class="card-title">${item.title}</h6>
                            <p class="text-success fs-5">${item.price}</p>
                            <p class="text-muted">${item.condition} • ${item.seller}</p>
                        </div>
                    </div>
                </div>
            `).join('') : '<div class="col-12 text-center"><p>No items found</p></div>';

            Swal.fire({
                title: 'Browse Items',
                html: `<div class="row g-3">${itemsHtml}</div>`,
                width: '90%',
                background: 'var(--dark-surface)',
                color: 'var(--text-primary)',
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        // Show item details
        function showItemDetails(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            const main = (item.images && item.images[0]) 
              ? `<img src="${item.images[0].data}" class="w-100" style="height:240px;object-fit:cover;border-radius:12px;">`
              : `<div class="d-flex align-items-center justify-content-center" style="height:240px;background:#49505755;border-radius:12px;">
                   <i class="bi bi-${getIconByCategory(item.category)}" style="font-size:3rem;color:#cbd5e1"></i>
                 </div>`;
            const thumbs = (item.images||[]).slice(1).map(im => `<img src="${im.data}" class="me-2 mt-2" style="width:70px;height:70px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.08)">`).join('');
            Swal.fire({
                title: item.title,
                html: `
                    <div class="container-fluid text-start">
                      <div class="row g-3">
                        <div class="col-md-5">
                          ${main}
                          ${thumbs ? `<div class="d-flex flex-wrap">${thumbs}</div>` : ''}
                        </div>
                        <div class="col-md-7">
                          <div class="price text-success fs-3 fw-bold mb-2">${item.price}</div>
                          <div class="mb-2">
                            <span class="badge-cond badge-${item.condition.toLowerCase().includes('excellent') ? 'excellent' : item.condition.toLowerCase().includes('good') ? 'good' : 'fair'}">${item.condition}</span>
                            <span class="ms-2 text-muted text-capitalize">Category: ${item.category}</span>
                          </div>
                          <p class="mb-1"><strong>Seller:</strong> ${item.seller}</p>
                          <p class="mb-1"><strong>Contact:</strong> ${item.contactMethod}</p>
                          <p class="mb-1"><strong>Meetup Location:</strong> ${item.location}</p>
                          <p class="mb-1"><strong>Posted:</strong> ${item.createdAt}</p>
                          <div class="mt-2"><strong>Description:</strong><br><span class="text-secondary">${item.description}</span></div>
                          <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-gradient" onclick="messageSeller('${encodeURIComponent(item.seller)}','${encodeURIComponent(item.contactMethod)}')">
                              <i class="bi bi-chat-dots me-1"></i> Message Seller
                            </button>
                            <button class="btn btn-outline-light" onclick="showCollectionDesk()">
                              <i class="bi bi-box-seam me-1"></i> Use Collection Desk
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>`,
                width: '820px',
                background: 'var(--dark-surface)',
                color: 'var(--text-primary)',
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        // Show collection desk
        
        // Message seller dialog (global for inline onclick)
        
        // Open chat with seller
        function messageSeller(nameEnc, methodEnc) {
            const seller = decodeURIComponent(nameEnc || 'Seller');
            const method = decodeURIComponent(methodEnc || '');
            currentChatUser = seller;
            if (!messages[seller]) {
                messages[seller] = [
                    {from: 'them', text: "Hi! I see you're interested in my item. How can I help you?", time: new Date()}
                ];
            }
            openChatWindow(seller, method);
        }

        function openChatWindow(seller, method){
            Swal.fire({
                title: `Chat with ${seller}`,
                html: `
                    <div class="chat-window">
                      <div class="chat-header">
                        <div class="chat-title"><i class="bi bi-person-circle me-1"></i> ${seller}</div>
                        <div class="chat-sub">Regarding your item listing${method ? ' • ' + method : ''}</div>
                      </div>
                      <div id="chatBody" class="chat-body"></div>
                      <div class="chat-input">
                        <input id="chatInput" type="text" placeholder="Type a message...">
                        <button id="chatSend" class="btn btn-gradient chat-send"><i class="bi bi-send"></i></button>
                      </div>
                    </div>`,
                width: 520,
                background: 'var(--dark-surface)',
                color: 'var(--text-primary)',
                showConfirmButton: false,
                showCloseButton: true,
                didOpen: () => {
                    renderChat(seller);
                    const input = document.getElementById('chatInput');
                    const sendBtn = document.getElementById('chatSend');
                    input.focus();
                    input.addEventListener('keydown', (e)=>{
                        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(seller); }
                    });
                    sendBtn.addEventListener('click', ()=> sendChatMessage(seller));
                }
            });
        }

        function renderChat(seller){
            const body = document.getElementById('chatBody');
            if (!body) return;
            const msgs = messages[seller] || [];
            body.innerHTML = msgs.map(m => `
                <div class="d-flex ${m.from === 'me' ? 'justify-content-end' : 'justify-content-start'}">
                  <div class="bubble ${m.from === 'me' ? 'me' : 'them'}">
                    <div>${m.text.replace(/</g,'&lt;')}</div>
                    <div class="time">${new Date(m.time).toLocaleTimeString()}</div>
                  </div>
                </div>`
            ).join('');
            body.scrollTop = body.scrollHeight;
        }

        function sendChatMessage(seller){
            const input = document.getElementById('chatInput');
            const text = (input.value || '').trim();
            if (!text) return;
            messages[seller] = messages[seller] || [];
            messages[seller].push({from:'me', text, time: new Date()});
            input.value='';
            renderChat(seller);
            // optional auto-reply for demo
            setTimeout(()=>{
                messages[seller].push({from:'them', text: "Got it 👍", time: new Date()});
                renderChat(seller);
            }, 800);
        }
    // Show toast notification
        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // Back to top functionality
        function initializeBackToTop() {
            window.addEventListener('scroll', function() {
                const backToTopBtn = document.getElementById('backToTop');
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });
        }

        // Scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    </script>
</body>
</html>
