<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>初火</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700;900&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold-main: #d4af37; --gold-light: #f9d976; --gold-dark: #8d7026; 
            --bg-dark: #050505; --bg-card: rgba(20, 20, 20, 0.7);
        }
        body { 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 80%);
            color: #e5e5e5; font-family: 'Noto Serif SC', serif; -webkit-tap-highlight-color: transparent;
        }
        .font-num { font-family: 'Oswald', sans-serif; letter-spacing: 0.05em; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-card {
            background: var(--bg-card); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .dashboard-card {
            background: linear-gradient(180deg, rgba(30,30,30,0.8) 0%, rgba(10,10,10,0.9) 100%);
            border: 1px solid rgba(212, 175, 55, 0.1); box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }
        .neon-text-gold { text-shadow: 0 0 10px rgba(212, 175, 55, 0.5), 0 0 20px rgba(212, 175, 55, 0.3); }
        .neon-border-green { box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); }
        .neon-border-red { box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); }
        body:not(.is-admin) .admin-el { display: none !important; }
        
        /* Navigation Tabs */
        .tab-btn { position: relative; opacity: 0.6; transition: all 0.3s ease; }
        .tab-btn.active { opacity: 1; color: var(--gold-main); text-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px;
            background: var(--gold-main); box-shadow: 0 0 10px var(--gold-main);
        }

        /* View Transitions */
        .view-section {
            position: absolute; inset: 0; padding: 1rem 1rem 10rem 1rem; overflow-y: auto;
            transition: opacity 0.5s cubic-bezier(0.32, 0.72, 0, 1), transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            background-color: transparent; -ms-overflow-style: none; scrollbar-width: none;
        }
        .view-section::-webkit-scrollbar { display: none; }
        .view-active { opacity: 1; transform: scale(1); pointer-events: auto; z-index: 10; }
        .view-inactive { opacity: 0; transform: scale(0.95); pointer-events: none; z-index: 0; }

        /* Modal Transitions */
        #game-modal, #shop-modal { transition: opacity 0.4s cubic-bezier(0.32, 0.72, 0, 1); }
        #game-modal-content, #shop-modal-content { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-open #game-modal { opacity: 1; pointer-events: auto; }
        .modal-open #game-modal-content { transform: scale(1); }
        .modal-closed #game-modal { opacity: 0; pointer-events: none; }
        .modal-closed #game-modal-content { transform: scale(0.9); }

        /* Badges & Balls */
        .badge-pvp { background: rgba(153, 27, 27, 0.2); color: #fca5a5; border: 1px solid rgba(153, 27, 27, 0.4); }
        .badge-pve { background: rgba(30, 64, 175, 0.2); color: #93c5fd; border: 1px solid rgba(30, 64, 175, 0.4); }
        .badge-solo { background: rgba(107, 33, 168, 0.2); color: #d8b4fe; border: 1px solid rgba(107, 33, 168, 0.4); }
        .badge-mixed { background: rgba(146, 64, 14, 0.2); color: #fdba74; border: 1px solid rgba(146, 64, 14, 0.4); }
        .mini-ball {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
            display: inline-block; margin: 0 5px; transition: all 0.2s;
        }
        .ball-red { background: radial-gradient(circle at 30% 30%, #ff6b6b, #991b1b); box-shadow: 0 0 15px #991b1b; }
        .ball-green { background: radial-gradient(circle at 30% 30%, #4ade80, #166534); box-shadow: 0 0 15px #166534; }
        .ball-blue { background: radial-gradient(circle at 30% 30%, #60a5fa, #1e40af); box-shadow: 0 0 15px #1e40af; }
        .ball-gray { background: radial-gradient(circle at 30% 30%, #4b5563, #111827); border-color: #374151; }
        .ball-anim { animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        .settle-flash { animation: settleFlash 1s infinite alternate; }
        @keyframes settleFlash { from { box-shadow: inset 0 0 0 rgba(255,255,255,0); } to { box-shadow: inset 0 0 50px rgba(212, 175, 55, 0.3); } }

        /* === 战备商店 (SHOP) 样式移植 === */
        .shop-filter-btn {
            background: transparent; border: 1px solid rgba(201, 165, 77, 0.3);
            color: #888; padding: 6px 16px; border-radius: 30px;
            cursor: pointer; transition: all 0.3s; font-size: 12px; font-weight: bold;
        }
        .shop-filter-btn:hover, .shop-filter-btn.active {
            background: rgba(201, 165, 77, 0.1); border-color: #d4af37; color: #d4af37;
            box-shadow: 0 0 15px rgba(201, 165, 77, 0.2);
        }
        
        .shop-card-wrapper { perspective: 1000px; transition: all 0.5s ease; }
        .shop-card-wrapper.hidden-card { display: none; }

        .shop-card {
            position: relative; width: 100%; aspect-ratio: 0.7/1.1;
            background: #141414; border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s ease, box-shadow 0.3s ease;
            transform-style: preserve-3d; cursor: pointer; overflow: hidden; display: flex; flex-direction: column;
        }
        .shop-card::before {
            content: ""; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: skewX(-25deg); transition: 0.5s; pointer-events: none; z-index: 10;
        }
        .shop-card:hover::before { left: 150%; transition: 0.7s; }
        .shop-card:hover { box-shadow: 0 20px 50px rgba(201, 165, 77, 0.2); border-color: rgba(201, 165, 77, 0.5); }

        .shop-img-box { width: 100%; height: 60%; overflow: hidden; border-bottom: 2px solid #d4af37; position: relative; background: #000; }
        .shop-img-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .shop-card:hover .shop-img-box img { transform: scale(1.1); }

        .shop-content { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, #1a1a1a, #0f0f0f); position: relative; z-index: 2; }
        .shop-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .shop-card h3 { font-size: 16px; font-weight: 700; color: #fff; line-height: 1.2; margin: 0; }

        .shop-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; border: 1px solid; white-space: nowrap; text-transform: uppercase; }
        .tag-box { border-color: #d4af37; color: #d4af37; background: rgba(212, 175, 55, 0.1); }
        .tag-consumable { border-color: #ff6b6b; color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .tag-equip { border-color: #48dbfb; color: #48dbfb; background: rgba(72, 219, 251, 0.1); }
        .tag-penalty { border-color: #a55eea; color: #a55eea; background: rgba(165, 94, 234, 0.1); }
        .tag-vip { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        .shop-desc { font-size: 11px; color: #bbb; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .shop-footer { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: auto; text-align: center; }
        .shop-price { font-family: 'Oswald', sans-serif; font-size: 24px; color: #d4af37; text-shadow: 0 0 10px rgba(201, 165, 77, 0.3); }
        .shop-price::before { content: '$'; font-size: 14px; opacity: 0.6; margin-right: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden modal-closed" id="app-body">

    <header class="flex-none h-16 px-6 flex justify-between items-center border-b border-white/5 bg-black/60 backdrop-blur-md z-50 relative">
        <div class="flex items-center gap-3 cursor-pointer select-none" id="admin-trigger">
            <div class="w-9 h-9 rounded-full border border-[#d4af37]/30 flex items-center justify-center bg-gradient-to-b from-[#2a2a2a] to-[#0a0a0a] shadow-[0_0_10px_rgba(212,175,55,0.1)]">
                <i class="fa-solid fa-coins text-[#d4af37] text-xs"></i>
            </div>
            <h1 class="text-xl font-bold tracking-[0.25em] text-gold-gradient uppercase font-num">初火钱庄</h1>
        </div>
        
        <nav class="flex gap-4 md:gap-8 text-xs md:text-sm font-bold tracking-widest items-center">
            <button onclick="setTab('dashboard')" class="tab-btn active text-gray-400 hover:text-white pb-1">大盘监控</button>
            <button onclick="setTab('games')" class="tab-btn text-gray-400 hover:text-white pb-1">游戏手册</button>
            <button onclick="setTab('shop')" class="tab-btn text-gray-400 hover:text-white pb-1">战备商店</button> <button onclick="attemptLogin()" class="text-gray-600 hover:text-[#d4af37] transition-colors px-2 ml-2"><i class="fa-solid fa-user-gear"></i></button>
        </nav>
    </header>

    <main class="flex-1 relative overflow-hidden bg-black/20 w-full">
        
        <section id="view-dashboard" class="view-section view-active">
            <div id="ticker-bar" class="w-full bg-black/40 border border-[#d4af37]/20 rounded-md p-2 mb-8 flex items-center shadow-[0_0_15px_rgba(212,175,55,0.05)] max-w-7xl mx-auto">
                <div id="ticker-label" class="bg-[#d4af37]/10 px-3 py-1 rounded text-xs text-[#d4af37] font-bold mr-3 whitespace-nowrap">LIVE FEED</div>
                <div class="flex-1 overflow-hidden relative h-5">
                    <p id="anno-text" class="text-sm text-[#d4af37]/90 font-medium whitespace-nowrap absolute w-full truncate">初火钱庄交易系统已上线，请各位主帅前往各大站点进行博弈。</p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto space-y-8 pb-20">
                <div id="lottery-card" class="dashboard-card rounded-2xl p-6 text-center group">
                   <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                    <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-[#d4af37] to-transparent shadow-[0_0_15px_#d4af37]"></div>
                    <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                        <div class="text-center md:text-left">
                            <p class="text-[10px] text-[#d4af37] tracking-[0.4em] uppercase mb-2 opacity-80">Lottery Jackpot</p>
                            <div class="flex justify-center md:justify-start items-baseline gap-2">
                                <span class="text-2xl text-[#d4af37]/80 font-light">¥</span>
                                <span id="jackpot-display" class="text-5xl md:text-6xl font-black text-white font-num neon-text-gold tracking-tighter">0</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center justify-center h-24 bg-black/40 rounded-lg border border-white/5 relative overflow-hidden">
                            <div id="draw-placeholder" class="flex flex-col items-center transition-opacity duration-300">
                                <span class="text-xs text-gray-500 tracking-widest mb-1">WINNING COLORS</span>
                                <div class="flex gap-2 opacity-30">
                                    <div class="w-8 h-8 rounded-full border border-white/30"></div>
                                    <div class="w-8 h-8 rounded-full border border-white/30"></div>
                                    <div class="w-8 h-8 rounded-full border border-white/30"></div>
                                </div>
                            </div>
                            <div id="draw-active" class="hidden absolute inset-0 flex items-center justify-center gap-3 bg-black/80">
                                <div id="l-ball-1" class="mini-ball ball-gray"></div>
                                <div id="l-ball-2" class="mini-ball ball-gray"></div>
                                <div id="l-ball-3" class="mini-ball ball-gray"></div>
                            </div>
                            <div id="draw-result" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-20">
                                <div class="text-[10px] text-[#d4af37] tracking-[0.2em] mb-1">RESULT</div>
                                <div class="flex gap-2">
                                    <div id="r-ball-1" class="mini-ball ball-gray"></div>
                                    <div id="r-ball-2" class="mini-ball ball-gray"></div>
                                    <div id="r-ball-3" class="mini-ball ball-gray"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center md:text-right">
                            <div id="lottery-status-badge" class="inline-block px-3 py-1 rounded text-xs font-bold tracking-widest mb-2 bg-gray-800 text-gray-500 border border-gray-700">WAITING</div>
                            <div class="text-[10px] text-gray-400 mb-1 tracking-widest">NEXT DRAW IN</div>
                            <div id="timer-display" class="font-num text-4xl text-white font-bold">30:00</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="stock-002-card" class="dashboard-card rounded-2xl p-6 relative overflow-hidden transition-all duration-500">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="text-[10px] text-gray-500 tracking-[0.2em] uppercase mb-1">Stock Code</div>
                                    <div class="text-4xl font-black italic text-white font-num tracking-tight">002</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-500 tracking-[0.2em] uppercase mb-1">Win Rate</div>
                                    <div id="rate-002" class="text-3xl font-bold text-[#d4af37] font-num">0%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center py-4 my-2 bg-black/30 rounded border border-white/5">
                                <div id="stock-status-text-002" class="text-2xl font-bold text-gray-600 tracking-widest">WAITING</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-[10px] text-gray-500 mb-1">W / L</div>
                                    <div class="font-num text-sm space-x-2">
                                        <span class="text-green-500 font-bold" id="win-002">0</span>
                                        <span class="text-gray-600">/</span>
                                        <span class="text-red-500 font-bold" id="loss-002">0</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div id="stock-timer-label" class="text-[10px] text-gray-500 mb-1">CYCLE TIMER (35m)</div>
                                    <div id="stock-timer-display" class="font-num text-xl text-white">35:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="stock-004-card" class="dashboard-card rounded-2xl p-6 relative overflow-hidden transition-all duration-500">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                        <div class="relative z-10 flex flex-col h-full justify-between">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="text-[10px] text-gray-500 tracking-[0.2em] uppercase mb-1">Stock Code</div>
                                    <div class="text-4xl font-black italic text-white font-num tracking-tight">004</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-500 tracking-[0.2em] uppercase mb-1">Win Rate</div>
                                    <div id="rate-004" class="text-3xl font-bold text-[#d4af37] font-num">0%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center py-4 my-2 bg-black/30 rounded border border-white/5">
                                <div id="stock-status-text-004" class="text-2xl font-bold text-gray-600 tracking-widest">WAITING</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-[10px] text-gray-500 mb-1">W / L</div>
                                    <div class="font-num text-sm space-x-2">
                                        <span class="text-green-500 font-bold" id="win-004">0</span>
                                        <span class="text-gray-600">/</span>
                                        <span class="text-red-500 font-bold" id="loss-004">0</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-500 mb-1">CYCLE TIMER</div>
                                    <div class="font-num text-xl text-white stock-shared-timer">35:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-games" class="view-section view-inactive">
            <div class="max-w-7xl mx-auto pb-20">
                <h2 class="text-center text-xl text-gold-gradient font-bold mb-8 tracking-[0.3em] font-num uppercase border-b border-white/5 pb-4">Game Manual</h2>
                <div id="games-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    </div>
            </div>
        </section>

        <section id="view-shop" class="view-section view-inactive">
            <div class="max-w-7xl mx-auto pb-20">
                <div class="text-center pt-5 pb-8">
                    <h1 class="text-4xl md:text-5xl font-bold uppercase tracking-[0.2em] text-[#d4af37] mb-2 font-num">战略补給总览</h1>
                    <div class="text-xs opacity-70 tracking-[0.3em] text-gray-400 mb-8"></div>
                    
                    <div class="flex justify-center flex-wrap gap-2 px-4">
                        <button class="shop-filter-btn active" data-filter="all">全部 ALL</button>
                        <button class="shop-filter-btn" data-filter="ammo">军火</button>
                        <button class="shop-filter-btn" data-filter="survival">生存</button>
                        <button class="shop-filter-btn" data-filter="combat">战斗</button>
                        <button class="shop-filter-btn" data-filter="penalty">天罚</button>
                        <button class="shop-filter-btn" data-filter="site">站点</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8 px-2 md:px-0" id="shop-container">
                    <div class="shop-card-wrapper" data-category="ammo">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="standard.png" onerror="this.src='https://placehold.co/688x976/222/c9a54d?text=STANDARD'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>标准军火包</h3><span class="shop-tag tag-box">盲盒</span></div>
                                <div class="shop-desc">随机获得 3 张基础卡牌（杀、闪、破）。</div>
                                <div class="hidden hidden-value">维持军队基本战斗力的刚需补给。</div>
                                <div class="shop-footer"><div class="shop-price">100</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="ammo">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="drawsolo.png" onerror="this.src='https://placehold.co/688x976/222/c9a54d?text=SOLO'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>单抽补给</h3><span class="shop-tag tag-box">盲盒</span></div>
                                <div class="shop-desc">现场抽取 1 張基础卡牌，即买即用。</div>
                                <div class="hidden hidden-value">急需一张牌救急时的赌博性购买。</div>
                                <div class="shop-footer"><div class="shop-price">40</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="ammo">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="tuiji.png" onerror="this.src='https://placehold.co/688x976/222/c9a54d?text=ASSAULT'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>突击卡包</h3><span class="shop-tag tag-box">定向</span></div>
                                <div class="shop-desc">必定获得：2 张杀 + 1 张破。</div>
                                <div class="hidden hidden-value">确保拥有足够火力去抢夺物资。</div>
                                <div class="shop-footer"><div class="shop-price">200</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="ammo">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="tiebi.png" onerror="this.src='https://placehold.co/688x976/222/c9a54d?text=DEFENSE'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>铁壁卡包</h3><span class="shop-tag tag-box">定向</span></div>
                                <div class="shop-desc">必定获得：2 张闪 + 1 张杀。</div>
                                <div class="hidden hidden-value">为负重者提供最稳定的防御手段。</div>
                                <div class="shop-footer"><div class="shop-price">200</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="survival">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_135311.png" onerror="this.src='https://placehold.co/688x976/222/ff6b6b?text=REVIVE'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>生生不息</h3><span class="shop-tag tag-consumable">消耗品</span></div>
                                <div class="shop-desc">指定一名已淘汰玩家，立即复活至己方备战区。</div>
                                <div class="hidden hidden-value">获胜的基础前提是人数优势。</div>
                                <div class="shop-footer"><div class="shop-price">500</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="survival">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_135312.png" onerror="this.src='https://placehold.co/688x976/222/ff6b6b?text=ADRENALINE'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>肾上腺素</h3><span class="shop-tag tag-consumable">消耗品</span></div>
                                <div class="shop-desc">指定玩家获得一次免窒息特权（2分钟）。</div>
                                <div class="hidden hidden-value">拼字卡壳时防暴毙的关键。</div>
                                <div class="shop-footer"><div class="shop-price">200</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="combat">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_135310.png" onerror="this.src='https://placehold.co/688x976/222/48dbfb?text=EXO'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>外骨骼</h3><span class="shop-tag tag-equip">装备</span></div>
                                <div class="shop-desc">负重状态下依然可以使用「闪」。</div>
                                <div class="hidden hidden-value">运货神器，让搬运兵具备战斗力。</div>
                                <div class="shop-footer"><div class="shop-price">600</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="combat">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_135314.png" onerror="this.src='https://placehold.co/688x976/222/48dbfb?text=MAGNET'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>磁力手套</h3><span class="shop-tag tag-equip">装备</span></div>
                                <div class="shop-desc">使用弃包防御时物资依然黏在手上。</div>
                                <div class="hidden hidden-value">防守物资的赖皮神级装备。</div>
                                <div class="shop-footer"><div class="shop-price">800</div></div>
                            </div>
                        </div>
                    </div>
                     <div class="shop-card-wrapper" data-category="combat">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13531.png" onerror="this.src='https://placehold.co/688x976/222/e6c77a?text=ARMOR+BREAK'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>碎甲破</h3><span class="shop-tag tag-box">攻击</span></div>
                                <div class="shop-desc">代替「破」打出，击败重装兵则秒杀。</div>
                                <div class="hidden hidden-value">专门拆除敌方重装防线。</div>
                                <div class="shop-footer"><div class="shop-price">400</div></div>
                            </div>
                        </div>
                    </div>
                     <div class="shop-card-wrapper" data-category="combat">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13532.png" onerror="this.src='https://placehold.co/688x976/222/e6c77a?text=BLOOD+KILL'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>嗜血杀</h3><span class="shop-tag tag-box">攻击</span></div>
                                <div class="shop-desc">代替「杀」打出，获胜掠夺双倍物资。</div>
                                <div class="hidden hidden-value">顺风局拉开资源差距的利器。</div>
                                <div class="shop-footer"><div class="shop-price">150</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="penalty">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13533.png" onerror="this.src='https://placehold.co/688x976/222/a55eea?text=WILD+CARD'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>万能部首</h3><span class="shop-tag tag-penalty">特殊</span></div>
                                <div class="shop-desc">拼字时可代表任意笔画或偏旁。</div>
                                <div class="hidden hidden-value">只差最后一笔时的终结绝杀。</div>
                                <div class="shop-footer"><div class="shop-price">2000</div></div>
                            </div>
                        </div>
                    </div>
                     <div class="shop-card-wrapper" data-category="penalty">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13535.png" onerror="this.src='https://placehold.co/688x976/222/a55eea?text=BEACON'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>远程信标</h3><span class="shop-tag tag-penalty">特殊</span></div>
                                <div class="shop-desc">空投包直接扔进己方备战区。</div>
                                <div class="hidden hidden-value">零风险获取资源，适合劣势局。</div>
                                <div class="shop-footer"><div class="shop-price">200</div></div>
                            </div>
                        </div>
                    </div>
                     <div class="shop-card-wrapper" data-category="penalty">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13537.png" onerror="this.src='https://placehold.co/688x976/222/a55eea?text=GOD+MODE'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>钦天监</h3><span class="shop-tag tag-penalty">天罚</span></div>
                                <div class="shop-desc">强制指定下一轮禁字属性。</div>
                                <div class="hidden hidden-value">利用规则抹杀对手主力。</div>
                                <div class="shop-footer"><div class="shop-price">800</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="shop-card-wrapper" data-category="site">
                        <div class="shop-card" onclick="openShopModal(this)">
                            <div class="shop-img-box"><img src="IMG_13538.png" onerror="this.src='https://placehold.co/688x976/222/fff?text=VIP'"></div>
                            <div class="shop-content">
                                <div class="shop-header"><h3>优先通道卡</h3><span class="shop-tag tag-vip">特权</span></div>
                                <div class="shop-desc">无需排队，直接挑战任何一个 Station。</div>
                                <div class="hidden hidden-value">时间管理，在有限时间内赚更多分。</div>
                                <div class="shop-footer"><div class="shop-price">150</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="game-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pointer-events-none opacity-0">
        <div id="game-modal-content" class="bg-[#111] border border-[#d4af37]/30 w-full max-w-2xl rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden transform scale-90">
            <div class="bg-gradient-to-r from-[#d4af37]/20 to-transparent p-6 border-b border-[#d4af37]/20">
                <div class="flex justify-between items-start">
                    <div>
                        <div id="modal-type" class="inline-block px-3 py-1 rounded text-xs font-bold tracking-widest mb-2 border">PVP</div>
                        <h2 id="modal-title" class="text-2xl md:text-3xl font-bold text-white leading-tight">Game Title</h2>
                    </div>
                    <button onclick="closeGameDetails()" class="text-gray-400 hover:text-white transition p-2">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 md:p-8 space-y-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded border border-white/10">
                        <div class="text-[10px] text-gray-500 tracking-widest uppercase mb-1">Entry Fee</div>
                        <div id="modal-cost" class="text-xl font-num text-[#d4af37]">0</div>
                    </div>
                    <div class="bg-white/5 p-4 rounded border border-white/10">
                        <div class="text-[10px] text-gray-500 tracking-widest uppercase mb-1">Location</div>
                        <div id="modal-location" class="text-xl text-gray-300">Station X</div>
                    </div>
                </div>
                <div>
                    <h3 class="text-[#d4af37] font-bold text-sm tracking-widest uppercase mb-3 border-l-2 border-[#d4af37] pl-3">详细规则</h3>
                    <p id="modal-desc" class="text-gray-300 text-sm leading-relaxed whitespace-pre-line">Game Rules...</p>
                </div>
                <div class="bg-green-900/10 border border-green-500/30 p-4 rounded-lg">
                    <h3 class="text-green-500 font-bold text-xs tracking-widest uppercase mb-2">完胜条件 Perfect Win</h3>
                    <p id="modal-perfect" class="text-green-300 text-sm font-bold">Condition...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="fixed inset-0 z-[110] bg-black/90 backdrop-blur-sm flex items-center justify-center pointer-events-none opacity-0">
        <div id="shop-modal-content" class="bg-[#111] border-2 border-[#d4af37] w-[90%] max-w-[800px] flex flex-col md:flex-row rounded-xl overflow-hidden shadow-[0_0_50px_rgba(212,175,55,0.4)] transform scale-90">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-20" onclick="closeShopModal()"><i class="fa-solid fa-xmark"></i></button>
            <div class="w-full md:w-[40%] bg-black relative h-64 md:h-auto">
                <img id="sm-img" src="" alt="" class="w-full h-full object-cover opacity-90">
            </div>
            <div class="w-full md:w-[60%] p-8 flex flex-col justify-center relative">
                <span id="sm-tag" class="inline-block text-[#d4af37] border border-[#d4af37] px-4 py-1 rounded-full text-xs font-bold w-fit mb-4">TAG</span>
                <h2 id="sm-title" class="text-3xl text-white font-bold mb-2">Title</h2>
                <div id="sm-price" class="text-4xl text-[#d4af37] font-num mb-6 border-b border-white/10 pb-4">000</div>
                <p id="sm-desc" class="text-gray-300 text-sm leading-relaxed mb-6">Description</p>
                <div class="bg-white/5 p-4 rounded border-l-4 border-green-500">
                    <p id="sm-value" class="text-gray-400 text-xs italic">Strategy Value</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="admin-el fixed bottom-0 w-full bg-[#050505]/95 backdrop-blur-xl border-t border-[#d4af37]/50 p-6 z-50 shadow-[0_-10px_40px_rgba(0,0,0,1)] transition-transform duration-300">
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="space-y-3 border-r border-white/10 pr-6">
                <h3 class="text-[#d4af37] font-bold tracking-[0.2em] text-xs uppercase mb-2"><i class="fa-solid fa-dice mr-2"></i>Lottery (30m)</h3>
                <div class="flex gap-2">
                    <button onclick="modLotteryTime(5)" class="flex-1 bg-gray-800 text-green-400 border border-white/10 rounded py-2 text-xs font-bold">+5m</button>
                    <button onclick="modLotteryTime(-5)" class="flex-1 bg-gray-800 text-red-400 border border-white/10 rounded py-2 text-xs font-bold">-5m</button>
                    <button onclick="resetLotteryTime()" class="flex-1 bg-gray-700 text-white border border-white/10 rounded py-2 text-xs font-bold">RESET</button>
                </div>
                <button onclick="autoSettleLottery()" class="w-full bg-[#d4af37]/20 text-[#d4af37] border border-[#d4af37]/50 rounded py-2 text-xs font-bold hover:bg-[#d4af37]/40">FORCE DRAW NOW</button>
                <div class="flex gap-2 mt-1">
                    <input id="input-jackpot" type="number" class="bg-black border border-white/20 text-white text-xs p-2 w-24 text-center font-num" placeholder="¥ Amount">
                    <button onclick="setJackpot()" class="flex-1 bg-white/10 text-gray-300 border border-white/20 rounded py-2 text-xs font-bold">SET POOL</button>
                </div>
            </div>
            <div class="space-y-3 border-r border-white/10 pr-6">
                <h3 class="text-[#d4af37] font-bold tracking-[0.2em] text-xs uppercase mb-2"><i class="fa-solid fa-arrow-trend-up mr-2"></i>Stock (35m)</h3>
                <div class="flex justify-between items-center bg-white/5 p-2 rounded mb-2">
                    <span class="text-xs text-gray-400 font-bold px-2">TIME</span>
                    <div class="flex gap-2">
                        <button onclick="modStockTime(5)" class="px-2 py-1 bg-gray-800 text-green-400 text-[10px] rounded">+5</button>
                        <button onclick="modStockTime(-5)" class="px-2 py-1 bg-gray-800 text-red-400 text-[10px] rounded">-5</button>
                        <button onclick="resetStockTime()" class="px-2 py-1 bg-gray-700 text-white text-[10px] rounded hover:bg-red-900 transition-colors">RESET</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/5 p-2 rounded flex justify-between items-center">
                        <span class="text-gray-400 text-[10px] font-bold">002</span>
                        <div class="flex gap-1">
                            <button onclick="modStock('002', 'w', 1)" class="px-2 bg-green-900/40 text-green-500 rounded font-bold text-[10px] hover:bg-green-600 hover:text-black">W</button>
                            <button onclick="modStock('002', 'l', 1)" class="px-2 bg-red-900/40 text-red-500 rounded font-bold text-[10px] hover:bg-red-600 hover:text-black">L</button>
                        </div>
                    </div>
                    <div class="bg-white/5 p-2 rounded flex justify-between items-center">
                        <span class="text-gray-400 text-[10px] font-bold">004</span>
                        <div class="flex gap-1">
                            <button onclick="modStock('004', 'w', 1)" class="px-2 bg-green-900/40 text-green-500 rounded font-bold text-[10px] hover:bg-green-600 hover:text-black">W</button>
                            <button onclick="modStock('004', 'l', 1)" class="px-2 bg-red-900/40 text-red-500 rounded font-bold text-[10px] hover:bg-red-600 hover:text-black">L</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-3 flex flex-col justify-between">
                <div>
                    <h3 class="text-[#d4af37] font-bold tracking-[0.2em] text-xs uppercase mb-2"><i class="fa-solid fa-gear mr-2"></i>System</h3>
                    <button onclick="editAnno()" class="w-full bg-blue-900/10 hover:bg-blue-900/30 text-blue-400 border border-blue-900/30 rounded py-3 text-xs font-bold mb-2 text-left px-4">
                        <i class="fa-solid fa-bullhorn mr-2"></i> EDIT TICKER
                    </button>
                </div>
                <button onclick="logoutAdmin()" class="w-full bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 rounded py-4 text-xs font-bold tracking-widest flex items-center justify-center gap-2">
                    <i class="fa-solid fa-lock"></i> LOCK CONSOLE
                </button>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD0tDOe3lCgrT0ANIO87rlkigES_ivivfI",
          authDomain: "pycamp-9d9bb.firebaseapp.com",
          projectId: "pycamp-9d9bb",
          storageBucket: "pycamp-9d9bb.firebasestorage.app",
          messagingSenderId: "205817396545",
          appId: "1:205817396545:web:6d1a48fba84c50b79f35c0",
          measurementId: "G-HY0C949GMR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let __isAdmin = false;
        const STATE_REF = doc(db, "public", "state");
        const __SAVE_DEBOUNCE_MS = 800;
        let __saveTimer = null;
        let __saveInFlight = false;
        let __saveQueued = false;
        const CONFIG = { lotteryDuration: 30, stockDuration: 35, DATA_VERSION: "2.3" };
        
        let state = {
            version: CONFIG.DATA_VERSION,
            anno: "初火钱庄交易系统已上线，请各位主帅前往各大站点进行博弈。",
            jackpot: 5000,
            lotteryEndTime: Date.now() + CONFIG.lotteryDuration * 60000,
            stockEndTime: Date.now() + CONFIG.stockDuration * 60000,
            lotteryState: 'OPEN',
            lotteryResult: null,
            stockState: 'TRADING',
            stocks: { '002': { w: 0, l: 0 }, '004': { w: 0, l: 0 } },
            games: [
                { id: 1, type: 'PVP', name: '重生之变成石头剪刀布大师却因为平局破产这档事', cost: '动态', location: '待定', desc: '1. 基础规则：至少6人参与。每队发6张卡（2石2剪2布）。\n2. 流程：严格进行6轮，卡片必须用完，不可保留。每轮结算后公开弃牌。\n3. 死锁与悬赏：若平局，双方各扣除50道（场地费），本轮奖金（150）不发，直接注入悬赏池。下一轮赢家通吃。\n4. 最终审判：若第6轮依然平局，悬赏池被系统强制回收，无人能得。', perfect: '比分 5:1 或 6:0 (抽奖x1)' },
                { id: 2, type: 'PVE', name: '关于双峰塔不对等我打算开飞机把双峰塔撞了', cost: '200', location: '待定', desc: '1. 玩法：桌上有两堆硬币（左11，右18）。\n2. 操作：单取（拿走一堆中任意数量）或 双取（两堆同时拿走相同数量）。\n3. 胜利：拿走桌上最后一枚硬币者胜。\n4. 付费玩法：支付200可抢先手或指定先手。', perfect: '不买Add-on赢过Committee (抽奖x1)' },
                { id: 3, type: 'PVE', name: '关于我转生变成水瓶还要被扔这档事', cost: '200', location: '待定', desc: '1. 玩法：抛水瓶，旋转一圈后稳稳站立。\n2. 胜利：限时1分钟，成功次数多者胜；或竞速模式先成功5次者胜。\n3. Add-on：150道让NPC需成功7次；300道让NPC需连续成功5次。', perfect: '不买Add-on赢过Committee (抽奖x1)' },
                { id: 4, type: 'PVP', name: '重生之我变成瞎子', cost: '动态', location: '待定', desc: '1. 道具：海绵棒x2，眼罩x2。\n2. 玩法：戴眼罩原地转3圈迷失方向。依靠直觉或队友呼喊攻击。\n3. 判定：击中头部/躯干+1分，对手出界+1分。先得3分者胜。', perfect: '3:0 或 3:1 获胜 (抽奖x1)' },
                { id: 5, type: 'SOLO', name: '重生之我变成特工007', cost: '200', location: '待定', desc: '1. 玩法：1人挑战。穿越挂满铃铛的红绳阵取物。\n2. 判定：身体触碰铃铛发出声响即失败。\n3. Pay-to-Win：支付200道可剪断一条红绳。', perfect: '一次不失误穿过整个阵仗 (抽奖x1)' },
                { id: 6, type: 'PVP', name: '重生之我变成初音我婆', cost: '动态', location: '待定', desc: '1. 玩法：轮流抽取积木堆叠。若抽到指令积木（如“单脚站立抽”），必须执行。\n2. 判定：谁弄倒了塔，谁直接判负。\n3. 完胜：成功执行3次指令且塔未倒，或塔高度翻倍。', perfect: '执行3次指令且未倒 或 高度翻倍 (抽奖x1)' },
                { id: 7, type: 'PVP', name: '重生之我变成人体投篮机这些事', cost: '动态', location: '待定', desc: '1. 核心：4人投球，1人用头接。\n2. 限制：接球者头上绑篮筐，只能动身/头，绝对不可用手碰篮筐。\n3. 判定：限时1分钟，接球多者胜。', perfect: '接住10颗球 (抽奖x1)' },
                { id: 8, type: 'PVP', name: '重生之我变成拆弹专家', cost: '动态', location: '待定', desc: '1. 配置：指挥官（能看不能动）+ 拆弹员（戴眼罩能动）。\n2. 玩法：指挥官口头指挥拆弹员完成4x4拼图。\n3. 判定：先完成拼图者胜。', perfect: '60秒内完成 + 无废话/无肢体接触 (抽奖x1)' },
                { id: 9, type: 'PVP', name: '重生之我变成井字棋魂', cost: '动态', location: '待定', desc: '1. 流程：10米折返跑接力下棋。\n2. 前3人：负责“放”标志物。\n3. 第4人起：若未分胜负，跑过去必须“移动”己方一个标志物。\n4. 判定：先连成三点一线者胜。', perfect: '前3人直接连成一线 (抽奖x1)' },
                { id: 10, type: 'PVP/E', name: '重生之我变成诸葛亮', cost: '动态', location: '待定', desc: '1. 玩法：双方将100兵力分配给A、B、C三城。\n2. 判定：同时亮牌，兵力多者占城（相同平局）。\n3. 获胜：占领2座以上城池。\n4. 死局规则：若1胜1负1平，比较获胜城所耗兵力，兵力少者胜（以少胜多）。', perfect: '3:0 完胜 (抽奖x1)' },
                { id: 11, type: 'PVP', name: '重生之我变成迪达拉', cost: '动态', location: '待定', desc: '1. 规则：轮流给气球打气，每回合必须按1~5下。\n2. 反转：若敢一次性按超过5下且气球没爆，可反转回合（让对方连按两轮）。\n3. 判定：气球爆炸者负。', perfect: '成功执行2次以上“反转”且获胜 (抽奖x1)' },
                { id: 12, type: 'PVP', name: '重生之我变成狗', cost: '动态', location: '待定', desc: '1. 配置：7杯水，其中1杯是炸弹（醋/蛇草水）。\n2. 玩法：两队轮流选一杯一口闷。\n3. 判定：喝到炸弹者判负。但若喝完面无表情骗过对方（对方以为是水），则反杀获胜。', perfect: '喝炸弹骗过对方 或 首轮选中对方炸弹 (抽奖x1)' }
            ]
        };

        function init() {
            startFirebaseSync();
            renderAll();
            startLoop();
            setupAdminTrigger();
            initShopEffects(); // Initialize Shop Logic
        }

        // === SHOP LOGIC ===
        let _shopInitialized = false;
        function initShopEffects() {
            if(_shopInitialized) return;
            _shopInitialized = true;
            // Filters
            const filterBtns = document.querySelectorAll('.shop-filter-btn');
            const cards = document.querySelectorAll('.shop-card-wrapper');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.getAttribute('data-filter');
                    cards.forEach(card => {
                        if (filter === 'all' || card.getAttribute('data-category') === filter) {
                            card.classList.remove('hidden-card');
                            setTimeout(() => card.style.opacity = '1', 50);
                        } else {
                            card.style.opacity = '0';
                            setTimeout(() => card.classList.add('hidden-card'), 300);
                        }
                    });
                });
            });
            // 3D Tilt
            const shopCards = document.querySelectorAll('.shop-card');
            shopCards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * -10;
                    const rotateY = ((x - centerX) / centerX) * 10;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });
        }
        function openShopModal(el) {
            const modal = document.getElementById('shop-modal');
            const content = document.getElementById('shop-modal-content');
            
            const img = el.querySelector('img').src;
            const title = el.querySelector('h3').innerText;
            const tag = el.querySelector('.shop-tag').innerText;
            const tagStyle = window.getComputedStyle(el.querySelector('.shop-tag'));
            const price = el.querySelector('.shop-price').innerText;
            const desc = el.querySelector('.shop-desc').innerText;
            const valEl = el.querySelector('.hidden-value'); 
            const value = valEl ? valEl.innerText : "No Data";

            document.getElementById('sm-img').src = img;
            document.getElementById('sm-title').innerText = title;
            const t = document.getElementById('sm-tag');
            t.innerText = tag;
            t.style.borderColor = tagStyle.borderColor;
            t.style.color = tagStyle.color;
            document.getElementById('sm-price').innerText = price;
            document.getElementById('sm-desc').innerText = desc;
            document.getElementById('sm-value').innerText = value;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('modal-open');
            content.classList.remove('scale-90');
            content.classList.add('scale-100');
        }
        function closeShopModal() {
            const modal = document.getElementById('shop-modal');
            const content = document.getElementById('shop-modal-content');
            modal.classList.remove('modal-open');
            modal.classList.add('opacity-0', 'pointer-events-none');
            content.classList.add('scale-90');
            content.classList.remove('scale-100');
        }

        // === MAIN LOGIC ===
        function renderAll() {
            const ticker = document.getElementById('ticker-bar');
            const annoText = document.getElementById('anno-text');
            if(!state.anno) ticker.classList.add('hidden');
            else { ticker.classList.remove('hidden'); annoText.innerText = state.anno; }
            document.getElementById('jackpot-display').innerText = state.jackpot.toLocaleString();
            updateStockUI('002');
            updateStockUI('004');
            const container = document.getElementById('games-container');
            if(container) {
                container.innerHTML = state.games.map(g => `
                    <div class="glass-card p-5 rounded-lg relative hover:bg-white/5 transition-colors group border border-white/5 hover:border-[#d4af37]/30 cursor-pointer" onclick="openGameDetails(${g.id})">
                        <div class="flex justify-between items-center mb-4 pointer-events-none">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded tracking-wider ${g.type === 'PVP' ? 'badge-pvp' : g.type === 'PVE' ? 'badge-pve' : 'badge-mixed'}">${g.type}</span>
                            <div class="text-right">
                                 <span class="text-[#d4af37] font-serif italic text-xl font-bold">Game ${g.id}</span>
                                 <div class="text-[10px] text-gray-500 flex items-center justify-end gap-1 mt-0.5"><i class="fa-solid fa-location-dot"></i> ${g.location || '待定'}</div>
                            </div>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-1 whitespace-nowrap overflow-hidden text-ellipsis pointer-events-none">${g.name}</h3>
                        <div class="flex justify-between text-xs text-gray-400 mb-4 pb-3 border-b border-white/10 items-center pointer-events-none">
                            <span class="uppercase tracking-widest text-[10px]">Entry Fee</span>
                            <span class="text-white font-num text-lg text-[#d4af37]">${g.cost}</span>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed mb-4 h-10 overflow-hidden text-ellipsis opacity-80 pointer-events-none">${g.desc}</p>
                        <div class="bg-gradient-to-r from-[#d4af37]/10 to-transparent p-2 rounded-l border-l-2 border-[#d4af37] pointer-events-none">
                            <div class="text-[9px] text-[#d4af37] font-bold uppercase mb-0.5 tracking-wider">Perfect Win</div>
                            <div class="text-xs text-gray-300 leading-tight truncate">${g.perfect}</div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-[#d4af37] opacity-0 group-hover:opacity-100 transition text-xs flex items-center gap-1">
                            查看详情 <i class="fa-solid fa-arrow-right"></i>
                        </div>
                        <button onclick="event.stopPropagation(); editGame(${g.id})" class="admin-el absolute top-4 right-4 text-gray-600 hover:text-white bg-black/50 w-6 h-6 rounded-full items-center justify-center z-10"><i class="fa-solid fa-pen text-xs"></i></button>
                    </div>
                `).join('');
            }
            renderLotteryUIFromState();
        }

        function renderLotteryUIFromState() {
            const placeholder = document.getElementById('draw-placeholder');
            const active = document.getElementById('draw-active');
            const result = document.getElementById('draw-result');
            if (!placeholder || !active || !result) return;
            const startAnim = () => {
                if (__drawAnimRunning) return;
                __drawAnimRunning = true;
                __drawAnimTimer = setInterval(() => {
                    const balls = document.querySelectorAll('#draw-active .mini-ball');
                    balls.forEach(b => { b.className = `mini-ball ${COLORS[Math.floor(Math.random() * COLORS.length)]} ball-anim`; });
                }, 100);
            };
            const stopAnim = () => {
                __drawAnimRunning = false;
                if (__drawAnimTimer) { clearInterval(__drawAnimTimer); __drawAnimTimer = null; }
            };
            placeholder.classList.add('hidden');
            active.classList.add('hidden'); active.classList.remove('flex');
            result.classList.add('hidden'); result.classList.remove('flex');
            if (state.lotteryState === 'DRAWING') {
                active.classList.remove('hidden'); active.classList.add('flex'); startAnim(); return;
            }
            stopAnim();
            if (state.lotteryState === 'RESULT' && Array.isArray(state.lotteryResult) && state.lotteryResult.length === 3) {
                const [r1, r2, r3] = state.lotteryResult;
                result.classList.remove('hidden'); result.classList.add('flex');
                const b1 = document.getElementById('r-ball-1'); const b2 = document.getElementById('r-ball-2'); const b3 = document.getElementById('r-ball-3');
                if (b1) b1.className = `mini-ball ${r1}`; if (b2) b2.className = `mini-ball ${r2}`; if (b3) b3.className = `mini-ball ${r3}`;
                return;
            }
            placeholder.classList.remove('hidden');
        }

        function openGameDetails(id) {
            const g = state.games.find(x => x.id === id);
            if(!g) return;
            document.getElementById('modal-type').innerText = g.type;
            document.getElementById('modal-type').className = `inline-block px-3 py-1 rounded text-xs font-bold tracking-widest mb-2 border ${g.type === 'PVP' ? 'badge-pvp' : g.type === 'PVE' ? 'badge-pve' : 'badge-mixed'}`;
            document.getElementById('modal-title').innerText = g.name;
            document.getElementById('modal-cost').innerText = g.cost;
            document.getElementById('modal-location').innerText = g.location || '待定';
            document.getElementById('modal-desc').innerText = g.desc;
            document.getElementById('modal-perfect').innerText = g.perfect;
            const body = document.getElementById('app-body');
            body.classList.remove('modal-closed'); body.classList.add('modal-open');
        }
        function closeGameDetails() {
            const body = document.getElementById('app-body');
            body.classList.remove('modal-open'); body.classList.add('modal-closed');
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeGameDetails(); closeShopModal(); } });
        document.getElementById('game-modal').addEventListener('click', (e) => { if(e.target.id === 'game-modal') closeGameDetails(); });
        document.getElementById('shop-modal').addEventListener('click', (e) => { if(e.target.id === 'shop-modal') closeShopModal(); });

        function updateStockUI(code) {
            const s = state.stocks[code];
            const total = s.w + s.l;
            const rate = total === 0 ? 0 : Math.round((s.w / total) * 100);
            const wEl = document.getElementById(`win-${code}`);
            if(wEl) wEl.innerText = s.w;
            document.getElementById(`loss-${code}`).innerText = s.l;
            document.getElementById(`rate-${code}`).innerText = rate + "%";
            const statusText = document.getElementById(`stock-status-text-${code}`);
            const card = document.getElementById(`stock-${code}-card`);
            let displayText = "WAITING";
            let colorClass = "text-gray-600";
            let borderClass = "";
            if (total < 5) { displayText = "流局 (REFUND)"; colorClass = "text-gray-500"; } 
            else if (rate >= 80) { displayText = "疯牛 (+200%)"; colorClass = "text-green-400 neon-text-gold"; borderClass = "neon-border-green"; } 
            else if (rate >= 60) { displayText = "牛市 (+150)"; colorClass = "text-green-500"; } 
            else if (rate >= 40) { displayText = "震荡 (-5%)"; colorClass = "text-yellow-500"; } 
            else { displayText = "崩盘 (-50%)"; colorClass = "text-red-600 neon-text-red"; borderClass = "neon-border-red"; }
            statusText.innerText = displayText;
            statusText.className = `text-2xl font-bold tracking-widest ${colorClass}`;
            card.classList.remove('neon-border-green', 'neon-border-red');
            if(state.stockState === 'SETTLED' && borderClass) { card.classList.add(borderClass); card.classList.add('settle-flash'); } 
            else { card.classList.remove('settle-flash'); }
        }

        function startLoop() {
            setInterval(() => {
                const now = Date.now();
                let lDiff = state.lotteryEndTime - now;
                const lStatusEl = document.getElementById('lottery-status-badge');
                const lTimerEl = document.getElementById('timer-display');
                const isRemoteLockedState = (state.lotteryState === 'DRAWING' || state.lotteryState === 'RESULT');
                if (lDiff <= 0) {
                  if (__isAdmin && state.lotteryState !== 'DRAWING' && state.lotteryState !== 'RESULT') { autoSettleLottery(); }
                  lTimerEl.innerText = "00:00";
                } else {
                  const m = Math.floor(lDiff / 60000);
                  const s = Math.floor((lDiff % 60000) / 1000);
                  lTimerEl.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                  if (!isRemoteLockedState) {
                    if (m < 5) {
                      state.lotteryState = 'FROZEN';
                      lStatusEl.innerText = "FROZEN (CLOSED)";
                      lStatusEl.className = "inline-block px-3 py-1 rounded text-xs font-bold tracking-widest mb-2 bg-red-900/30 text-red-400 border border-red-900";
                    } else {
                      state.lotteryState = 'OPEN';
                      lStatusEl.innerText = "OPEN FOR BET";
                      lStatusEl.className = "inline-block px-3 py-1 rounded text-xs font-bold tracking-widest mb-2 bg-green-900/30 text-green-400 border border-green-900 shadow-[0_0_10px_rgba(34,197,94,0.3)]";
                    }
                  }
                }
                renderLotteryUIFromState();
                
                let sDiff = state.stockEndTime - now;
                const sTimers = document.querySelectorAll('.stock-shared-timer');
                const sTimerDisplay = document.getElementById('stock-timer-display');
                if(sTimerDisplay) sTimerDisplay.innerText = formatTime(sDiff);
                sTimers.forEach(el => el.innerText = formatTime(sDiff));
                if (sDiff <= 0) {
                    state.stockState = 'SETTLED';
                    updateStockUI('002'); updateStockUI('004');
                    sTimers.forEach(el => el.innerText = "SETTLED");
                } else {
                    const sm = Math.floor(sDiff / 60000);
                    if (sm >= 20) state.stockState = 'TRADING';
                    else state.stockState = 'LOCKED';
                }
            }, 1000);
        }

        function formatTime(ms) {
            if (ms < 0) return "00:00";
            const m = Math.floor(ms / 60000); const s = Math.floor((ms % 60000) / 1000);
            return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        const COLORS = ['ball-red', 'ball-green', 'ball-blue'];
        let __drawAnimTimer = null;
        let __drawAnimRunning = false;
        function autoSettleLottery() {
          if (!__isAdmin) { alert('Admin only'); return; }
          state.lotteryState = 'DRAWING'; state.lotteryResult = null; saveState();
          document.getElementById('draw-placeholder').classList.add('hidden');
          document.getElementById('draw-result').classList.add('hidden');
          document.getElementById('draw-active').classList.remove('hidden');
          document.getElementById('draw-active').classList.add('flex');
          const interval = setInterval(() => {
            const balls = document.querySelectorAll('#draw-active .mini-ball');
            balls.forEach(b => { b.className = `mini-ball ${COLORS[Math.floor(Math.random()*3)]} ball-anim`; });
          }, 100);
          setTimeout(() => { clearInterval(interval); finalizeLotteryDraw(); }, 5000);
        }
        function finalizeLotteryDraw() {
          if (!__isAdmin) { alert('Admin only'); return; }
          const r1 = COLORS[Math.floor(Math.random()*3)];
          const r2 = COLORS[Math.floor(Math.random()*3)];
          const r3 = COLORS[Math.floor(Math.random()*3)];
          state.lotteryState = 'RESULT'; state.lotteryResult = [r1, r2, r3]; saveState();
          setTimeout(() => { resetLotteryTime(); }, 60000);
        }
        function modLotteryTime(m) { if (!__isAdmin) { alert('Admin only'); return; } state.lotteryEndTime += m * 60000; saveState(); }
        function resetLotteryTime() { if (!__isAdmin) { alert('Admin only'); return; } state.lotteryEndTime = Date.now() + CONFIG.lotteryDuration * 60000; state.lotteryState='OPEN'; state.lotteryResult = null; saveState(); }
        function modStockTime(m) { if (!__isAdmin) { alert('Admin only'); return; } state.stockEndTime += m * 60000; saveState(); }
        function resetStockTime() {
            if (!__isAdmin) { alert('Admin only'); return; }
            if(confirm('⚠️ 确定重置股票周期吗？\n这将清空所有 002/004 的胜负场数！')) {
                state.stockEndTime = Date.now() + CONFIG.stockDuration * 60000; state.stockState='TRADING'; 
                state.stocks = { '002': { w: 0, l: 0 }, '004': { w: 0, l: 0 } };
                saveState(); renderAll(); 
            }
        }
        function modStock(code, type, val) {
            if (!__isAdmin) { alert('Admin only'); return; }
            state.stocks[code][type] += val; if (state.stocks[code][type] < 0) state.stocks[code][type] = 0;
            saveState(); renderAll();
        }
        function setJackpot() { if (!__isAdmin) { alert('Admin only'); return; } const val = document.getElementById('input-jackpot').value; if(val) { state.jackpot = parseInt(val); saveState(); renderAll(); } }
        function editAnno() { if (!__isAdmin) { alert('Admin only'); return; } const n = prompt("公告:", state.anno); if(n !== null) { state.anno = n; saveState(); renderAll(); } }
        function editGame(id) {
            if (!__isAdmin) { alert('Admin only'); return; }
            const g = state.games.find(x => x.id === id);
            const cost = prompt("Fee:", g.cost);
            if(cost) { g.cost = cost; const loc = prompt("Location:", g.location); if(loc) g.location = loc; saveState(); renderAll(); }
        }
        
        // Tab Control
        function setTab(t) {
            const db = document.getElementById('view-dashboard');
            const gm = document.getElementById('view-games');
            const sh = document.getElementById('view-shop');
            const btns = document.querySelectorAll('.tab-btn');
            [db, gm, sh].forEach(el => { if(el) { el.classList.remove('view-active'); el.classList.add('view-inactive'); } });
            btns.forEach(b => b.classList.remove('active'));
            if(t === 'dashboard') {
                db.classList.remove('view-inactive'); db.classList.add('view-active'); btns[0].classList.add('active');
            } else if(t === 'games') {
                gm.classList.remove('view-inactive'); gm.classList.add('view-active'); btns[1].classList.add('active');
            } else if(t === 'shop') {
                sh.classList.remove('view-inactive'); sh.classList.add('view-active'); btns[2].classList.add('active');
                initShopEffects();
            }
        }

        function setupAdminTrigger() {
            let c = 0;
            document.getElementById('admin-trigger').addEventListener('click', () => { c++; if(c>=5) { c=0; attemptLogin(); } setTimeout(()=>c=0, 2000); });
        }
        async function attemptLogin() {
            if (document.body.classList.contains("is-admin")) return;
            const email = prompt("Admin Email:"); if (!email) return;
            const pass = prompt("Admin Password:"); if (!pass) return;
            try { await signInWithEmailAndPassword(auth, email, pass); alert("ADMIN ACTIVE"); } catch (e) { alert("Login failed: " + (e?.message || e)); }
        }
        async function logoutAdmin() { try { await signOut(auth); } catch (e) { console.warn(e); } document.body.classList.remove('is-admin'); }

        async function saveState() {
            if (!__isAdmin) return;
            __saveQueued = true; if (__saveTimer) return;
            __saveTimer = setTimeout(__flushSave, __SAVE_DEBOUNCE_MS);
        }
        async function __flushSave() {
            __saveTimer = null;
            if (__saveInFlight) { __saveTimer = setTimeout(__flushSave, __SAVE_DEBOUNCE_MS); return; }
            if (!__saveQueued) return;
            __saveQueued = false; __saveInFlight = true;
            const payload = {
                version: CONFIG.DATA_VERSION, anno: state.anno, lotteryState: state.lotteryState || 'OPEN',
                lotteryResult: Array.isArray(state.lotteryResult) ? state.lotteryResult : null,
                jackpot: state.jackpot, lotteryEndTime: state.lotteryEndTime, stockEndTime: state.stockEndTime,
                stocks: state.stocks, games: state.games, updatedAt: serverTimestamp()
            };
            try { await setDoc(STATE_REF, payload, { merge: true }); } catch (e) { console.warn("saveState() failed:", e); } finally { __saveInFlight = false; }
            if (__saveQueued) saveState();
        }

        function startFirebaseSync() {
            onAuthStateChanged(auth, (user) => {
                const isAdmin = !!user; __isAdmin = isAdmin; document.body.classList.toggle("is-admin", isAdmin);
                if (isAdmin) saveState();
            });
            onSnapshot(STATE_REF, (snap) => {
                if (!snap.exists()) {
                    if (__isAdmin) { console.warn("Creating doc..."); saveState(); } 
                    else { console.warn("Doc not found."); }
                    return;
                }
                const p = snap.data() || {};
                if (typeof p.anno === "string") state.anno = p.anno;
                if (typeof p.jackpot === "number") state.jackpot = p.jackpot;
                if (typeof p.lotteryState === "string") state.lotteryState = p.lotteryState;
                if (Array.isArray(p.lotteryResult) || p.lotteryResult === null) state.lotteryResult = p.lotteryResult;
                if (typeof p.lotteryEndTime === "number") state.lotteryEndTime = p.lotteryEndTime;
                if (typeof p.stockEndTime === "number") state.stockEndTime = p.stockEndTime;
                if (typeof p.stockState === "string") state.stockState = p.stockState;
                if (p.stocks && typeof p.stocks === "object") state.stocks = p.stocks;
                if (Array.isArray(p.games)) state.games = p.games;
                renderAll();
            });
        }
        Object.assign(window, {
            setTab, attemptLogin, openGameDetails, closeGameDetails, modLotteryTime, resetLotteryTime,
            autoSettleLottery, finalizeLotteryDraw, modStockTime, resetStockTime, modStock, setJackpot, 
            editAnno, editGame, logoutAdmin, openShopModal, closeShopModal
        });
        init();
    </script>
</body>
</html>


